!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},n.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){const{BarLengthError:o,DupChordError:r,TraceError:i,VolumeError:a}=n(6);class s{static processPedal(e){const t=e.Content;let n,o;for(;n=t.findIndex(e=>"PedalPress"===e.Type),o=t.findIndex(e=>"PedalRelease"===e.Type),-1!==n;){if(-1===o){const o=e.Meta.Duration-t[n].StartTime;t.splice(n,1),t.slice(n).forEach(e=>e.Duration=o);break}for(;o<n;)t.splice(o,1),o=t.findIndex(e=>"PedalRelease"===e.Type),n-=1;const r=t[o].StartTime-t[n].StartTime;t.splice(o,1),t.splice(n,1),t.slice(n,o).forEach(e=>e.Duration=r)}}constructor(e,t,n,o=!1){this.isSubtrack=o,this.ID=e.ID,this.Instruments=e.Instruments,this.Libraries=n,this.Content=e.Content,this.Settings=t.extend(),this.Context={afterTie:!1,notesBeforeTie:[],startTime:0,pitchQueue:[],warnings:[]}}parseTrack(){this.preprocess();const e=this.parseTrackContent();return s.processPedal(e),this.isSubtrack?[e]:this.Instruments.map(t=>{const n=Object.assign({},e.Meta,{Warnings:e.Meta.Warnings.slice()});return null===t.Proportion&&(t.Proportion=1),""===t.Instrument&&(t.Instrument="Piano"),{Instrument:t.Instrument,ID:this.ID?`${this.ID}#${t.Instrument}`:t.Instrument,Meta:n,Content:e.Content.map(e=>{let o=e.Volume*t.Proportion;return o>1&&(n.Warnings.push(new a(this.ID,[],o)),o=1),delete e.__oriDur,Object.assign({},e,{Volume:o})})}})}mergeMacro(){let e=this.Content.length,t=0;for(;t<e;){const n=this.Content[t];if("Macrotrack"===n.Type||n.Name in this.Libraries.Track){const o=this.Libraries.Track[n.Name];this.Content.splice(t,1,...o),e+=o.length-1}else t+=1}}preprocess(){if(this.mergeMacro(),1===this.Content.length)return;const e=this.Content.pop(),t=this.Content.pop();"BarLine"===e.Type&&"BarLine"===t.Type?(t.Terminal=!0,this.Content.push(t)):("BarLine"===e.Type&&(e.Terminal=!0),this.Content.push(t),this.Content.push(e))}parseTrackContent(){const e=[];let t,n,r=0,i=!0;for(const a of this.Content)switch(a.Type){case"FUNCTION":case"Subtrack":if("FUNCTION"===a.Type){if(void 0===(t=this.Libraries.FunctionPackage.applyFunction(this,a)))continue}else t=new c(a,this.Settings,this.Libraries,this.Context.pitchQueue).parseTrack();t.Content.forEach(e=>{"Note"===e.Type&&(e.StartTime+=this.Context.startTime)}),this.Context.startTime+=t.Meta.Duration,this.Context.notesBeforeTie=t.Meta.NotesBeforeTie,this.Context.warnings.push(...t.Meta.Warnings.map(e=>(e.args[0]=this.ID,e.args[1].unshift(this.Content.indexOf(a)),e))),t.Meta.Single?i?(r+=t.Meta.Incomplete[0],this.isLegalBar(r)&&(i=!1,n=0)):(n+=t.Meta.Incomplete[0],this.isLegalBar(n)&&(n=0)):i?(r+=t.Meta.Incomplete[0],i=!1,n=t.Meta.Incomplete[1],this.isLegalBar(n)&&(n=0)):(n+=t.Meta.Incomplete[0],this.isLegalBar(n)||this.Context.warnings.push(new o(this.ID,[this.Content.indexOf(a)],n)),n=t.Meta.Incomplete[1],this.isLegalBar(n)&&(n=0)),e.push(...t.Content);break;case"Note":this.Context.notesBeforeTie=this.parseNote(a),i?r+=this.parseBeat(a):n+=this.parseBeat(a),e.push(...this.Context.notesBeforeTie.filter(t=>-1===e.indexOf(t)));break;case"Tie":this.Context.afterTie=!0;break;case"BarLine":i=!1,!0!==a.Terminal&&(this.isLegalBar(n)||this.Context.warnings.push(new o(this.ID,[this.Content.indexOf(a)],n)),n=0);break;case"PedalPress":case"PedalRelease":e.push({Type:a.Type,StartTime:this.Context.startTime})}const a={Content:e,Meta:{Warnings:this.Context.warnings,PitchQueue:this.Context.pitchQueue,FadeIn:this.Settings.FadeIn,FadeOut:this.Settings.FadeOut,Duration:this.Context.startTime,Single:i,Incomplete:[r,n],NotesBeforeTie:this.Context.notesBeforeTie}};return this.isSubtrack||(a.Meta.toJSON=function(){return{FadeIn:this.FadeIn,FadeOut:this.FadeOut,Duration:this.Duration,Warnings:this.Warnings}},r+n!==this.Settings.Bar&&(r!==this.Settings.Bar&&this.Context.warnings.push(new o(this.ID,[0],r)),n&&n!==this.Settings.Bar&&this.Context.warnings.push(new o(this.ID,[-1],n)))),a}isLegalBar(e){return void 0===e||e===this.Settings.Bar||0===e}parseNote(e){const t=[],n=[],o=[],a=60*this.parseBeat(e)/this.Settings.Speed,s=a*(1-this.Settings.Stac[e.Staccato]);if(1===e.Pitches.length&&"%"===e.Pitches[0].Degree)if(this.Context.pitchQueue.length>=this.Settings.Trace){const n=this.parseDeltaPitch(e.PitOp),r=this.Context.pitchQueue[this.Context.pitchQueue.length-this.Settings.Trace];t.push(...[].concat(...r.map(e=>this.Settings.Key.map(t=>t-this.Settings.Key[0]+e+n)))),o.push(...[].concat(...new Array(r.length).fill(this.getVolume(e.VolOp))))}else this.Context.warnings.push(new i(this.ID,[this.Content.indexOf(e)],this.Settings.Trace));else for(const r of e.Pitches)if("0"!==r.Degree)if("x"===r.Degree)t.push(null),o.push(this.Settings.Volume[0]*e.VolOp.split("").reduce((e,t)=>e*t===">"?this.Settings.Accent:":"===t?this.Settings.Light:1,1));else if(""===r.Chord){const i=this.parsePitch(r,e.PitOp);n.push(i[0]),t.push(...i),o.push(...this.getVolume(e.VolOp+r.VolOp))}else{const i=this.parsePitch(r,e.PitOp),a=this.parseChord(r);n.push(...a.map(e=>e+i[0])),t.push(...[].concat(...a.map(e=>i.map(t=>e+t)))),o.push(...[].concat(...new Array(a.length).fill(this.getVolume(e.VolOp+r.VolOp))))}new Set(t).size!==t.length&&this.Context.warnings.push(new r(this.ID,[this.Content.indexOf(e)],t)),n.length>0&&this.Context.pitchQueue.push(n.slice(0));const c=[];this.Context.afterTie&&(this.Context.afterTie=!1,this.Context.notesBeforeTie.forEach(e=>{const n=t.indexOf(e.Pitch);-1!==n&&e.Volume===o[n]&&(c.push(e),e.__oriDur+=s,e.Duration=e.__oriDur,t.splice(n,1),o.splice(n,1))}));for(var u=0,h=t.length;u<h;u++)c.push({Type:"Note",Pitch:t[u],Volume:o[u],Duration:s,__oriDur:a,StartTime:this.Context.startTime});return this.Context.startTime+=a,c}getVolume(e){const t=e.split("").reduce((e,t)=>e*(">"===t?this.Settings.Accent:":"===t?this.Settings.Light:1),1),n=this.Settings.Key.length,o=this.Settings.Volume.length;return[...this.Settings.Volume,...new Array(n-o).fill(this.Settings.Volume[o-1])].map(e=>e*t)}parseChord(e){return e.Chord.split("").reduce((e,t)=>{const n=[];return this.Libraries.Chord[t].forEach(([t,o,r])=>{t>0&&(t-=1),o>0?n.push(...e.slice(t,o).map(e=>e+r)):-1===o?n.push(...e.slice(t).map(e=>e+r)):n.push(...e.slice(t,o+1).map(e=>e+r))}),n},[0])}parsePitch(e,t){const n=this.parseDeltaPitch(t)+s.pitchDict[e.Degree]+this.parseDeltaPitch(e.PitOp);return this.Settings.Key.map(e=>e+n)}parseDeltaPitch(e){return e.split("").reduce((e,t)=>e+s.pitchOperatorDict[t],0)}parseBeat(e){let t=1,n=0,o=0;const r=e.DurOp.length;for(;n<r;)switch(e.DurOp.charAt(n)){case"=":t/=4,n+=1;break;case"-":t+=1,n+=1;break;case"_":t/=2,n+=1;break;case".":for(o=1,n+=1;"."===e.DurOp.charAt(n);)o+=1,n+=1;t*=2-Math.pow(2,-o)}return t*Math.pow(2,-this.Settings.Duration)}}s.pitchDict={1:0,2:2,3:4,4:5,5:7,6:9,7:11},s.pitchOperatorDict={"#":1,b:-1,"'":12,",":-12};class c extends s{constructor(e,t,n,o){super(e,t,n,!0),this.Repeat=e.Repeat,this.Context.pitchQueue=o.slice()}parseTrack(){return this.preprocess(),this.parseTrackContent(this.Content)}preprocess(){if(this.mergeMacro(),-1!==this.Repeat&&this.Content.length>=1&&"BarLine"!==this.Content[this.Content.length-1].Type&&this.Content.push({Type:"BarLine",Skip:!1,Order:[0]}),this.Repeat>0){const e=[],t=this.Content.filter(e=>"BarLine"===e.Type&&0!==e.Order[0]),n=t.find(e=>0===e.Order.length);if(void 0!==n){const e=[].concat(...t.map(e=>e.Order));for(let t=1;t<this.Repeat;t++)-1===e.indexOf(t)&&n.Order.push(t)}for(let t=1;t<=this.Repeat;t++){let n=!1;for(const o of this.Content)"BarLine"!==o.Type||0===o.Order[0]?n||e.push(o):-1===o.Order.indexOf(t)?n=!0:(n=!1,e.push(o))}this.Content=e}else{const e=this.Content.findIndex(e=>!0===e.Skip);let t;-1===e?t=new Array(-this.Repeat).fill(this.Content):(t=new Array(-this.Repeat-1).fill(this.Content)).push(this.Content.slice(0,e)),this.Content=[].concat(...t)}}}e.exports={TrackParser:s,SubtrackParser:c}},function(e,t,n){var o,r=r||function(e){"use strict";if(!(void 0===e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=function(){return e.URL||e.webkitURL||e},n=e.document.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in n,r=/constructor/i.test(e.HTMLElement)||e.safari,i=/CriOS\/[\d]+/.test(navigator.userAgent),a=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s=function(e){setTimeout(function(){"string"==typeof e?t().revokeObjectURL(e):e.remove()},4e4)},c=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},u=function(u,h,l){l||(u=c(u));var p,d=this,g="application/octet-stream"===u.type,m=function(){!function(e,t,n){for(var o=(t=[].concat(t)).length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,e)}catch(e){a(e)}}}(d,"writestart progress write writeend".split(" "))};if(d.readyState=d.INIT,o)return p=t().createObjectURL(u),void setTimeout(function(){var e,t;n.href=p,n.download=h,e=n,t=new MouseEvent("click"),e.dispatchEvent(t),m(),s(p),d.readyState=d.DONE});!function(){if((i||g&&r)&&e.FileReader){var n=new FileReader;return n.onloadend=function(){var t=i?n.result:n.result.replace(/^data:[^;]*;/,"data:attachment/file;");e.open(t,"_blank")||(e.location.href=t),t=void 0,d.readyState=d.DONE,m()},n.readAsDataURL(u),void(d.readyState=d.INIT)}p||(p=t().createObjectURL(u)),g?e.location.href=p:e.open(p,"_blank")||(e.location.href=p),d.readyState=d.DONE,m(),s(p)}()},h=u.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=c(e)),navigator.msSaveOrOpenBlob(e,t)}:(h.abort=function(){},h.readyState=h.INIT=0,h.WRITING=1,h.DONE=2,h.error=h.onwritestart=h.onprogress=h.onwrite=h.onabort=h.onerror=h.onwriteend=null,function(e,t,n){return new u(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);void 0!==e&&e.exports?e.exports.saveAs=r:null!==n(13)&&null!==n(12)&&(void 0===(o=function(){return r}.call(t,n,t,e))||(e.exports=o))},function(e,t,n){"use strict";n.r(t);var o=n(1);const r={Piano:0,BrightPiano:1,ElectricGrandPiano:2,HonkyTonkPiano:3,ElectricPiano:4,ElectricPiano2:5,Harpsichord:6,Clavi:7,Celesta:8,Glockenspiel:9,MusicBox:10,Vibraphone:11,Marimba:12,Xylophone:13,TubularBells:14,Dulcimer:15,DrawbarOrgan:16,PercussiveOrgan:17,RockOrgan:18,Organ:19,ReedOrgan:20,Accordion:21,Harmonica:22,Bandoneon:23,Guitar:24,SteelGuitar:25,JazzGuitar:26,ElectricGuitar:27,GuitarMuted:28,GuitarOverdriven:29,GuitarDistorted:30,GuitarHarmonics:31,Bass:32,ElectricBass:33,PickedBass:34,FretlessBass:35,SlapBass:36,SlapBass2:37,SynthBass:38,SynthBass2:39,Violin:40,Viola:41,Cello:42,Contrabass:43,TremoloStrings:44,PizzicatoStrings:45,Harp:46,Timpani:47,Strings:48,Strings2:49,SynthStrings:50,SynthStrings2:51,VoiceAahs:52,VoiceOohs:53,Voice:54,OrchestraHit:55,Trumpet:56,Trombone:57,Tuba:58,MutedTrumpet:59,FrenchHorn:60,BrassSection:61,SynthBrass:62,SynthBrass2:63,SopranoSax:64,AltoSax:65,TenorSax:66,BaritoneSax:67,Oboe:68,EnglishHorn:69,Bassoon:70,Clarinet:71,Piccolo:72,Flute:73,Recorder:74,PanFlute:75,BlownBottle:76,Shakuhachi:77,Whistle:78,Ocarina:79,Square:80,Sawtooth:81,Calliope:82,Chiff:83,Charang:84,SynthVoice:85,Fifths:86,BassAndLead:87,NewAge:88,Warm:89,Polysynth:90,Choir:91,Bowed:92,Metallic:93,Halo:94,Sweep:95,Rain:96,Soundtrack:97,Crystal:98,Atmosphere:99,Brightness:100,Goblins:101,Echoes:102,SciFi:103,Sitar:104,Banjo:105,Shamisen:106,Koto:107,Kalimba:108,Bagpipe:109,Fiddle:110,Shanai:111,Tinklebell:112,Agogo:113,Steeldrums:114,Woodblock:115,Taiko:116,MelodicTom:117,SynthDrum:118,ReverseCymbal:119,FretNoise:120,Breath:121,Seashore:122,Bird:123,Telephone:124,Helicopter:125,Applause:126,Gunshot:127},i={BassDrum2:35,BassDrum:36,SideStick:37,Snare:38,Clap:39,ElectricSnare:40,LowFloorTom:41,HiHatClosed:42,LowTom:43,HiHatPedal:44,MidTom2:45,HiHatOpen:46,MidTom:47,HighFloorTom:48,CrashCymbal:49,HighTom:50,RideCymbal:51,ChineseCymbal:52,RideBell:53,Tambourine:54,SplashCymbal:55,Cowbell:56,CrashCymbal2:57,Vibraslap:58,RideCymbal2:59,HighBongo:60,LowBongo:61,HighCongaMute:62,HighCongaOpen:63,LowConga:64,HighTimbale:65,LowTimbale:66,HighAgogo:67,LowAgogo:68,Cabasa:69,Maracas:70,WhistleShort:71,WhistleLong:72,GuiroShort:73,GuiroLong:74,Claves:75,HighWoodblock:76,LowWoodblock:77,MuteCuica:78,OpenCuica:79,MuteTriangle:80,OpenTriangle:81},a="https://jjyyxx.github.io/webaudiofontdata/data/",s="Piano",c=n(11),u=n(10),h=n(8),l=n(3);window.fonts=window.fonts||{};class p{constructor(e){this.value=e;const t=new h(new c(e).tokenize(),new l).parse();this.tracks=t.tracks,this.time=t.time,this.dueTime=void 0,this.ctx=new AudioContext,this.player=new u}play(){const e=this.tracks.map(e=>e.Instrument);Promise.all(e.map(e=>this.player.loader.load(this.ctx,(e=e,""===e&&(e=s),e in r?a+("00"+r[e].toString()).slice(-3)+"0_FluidR3_GM_sf2_file.json":a+"128"+i[e].toString()+"_0_FluidR3_GM_sf2_file.json"),function(e){return""===e&&(e=s),e in r?"_tone_"+("00"+r[e].toString()).slice(-3)+"0_FluidR3_GM_sf2_file":"_drum_"+i[e].toString()+"_0_FluidR3_GM_sf2_file"}(e)))).then(e=>{const t=this.ctx.currentTime;this.dueTime=t+this.time;for(var n=0,o=this.tracks.length;n<o;n++){const o=this.tracks[n].Content;for(var r=0,a=o.length;r<a;r++)"Note"===o[r].Type&&this.player.queueWaveTable(this.ctx,this.ctx.destination,window.fonts[e[n]],o[r].StartTime+t,null===o[r].Pitch?i[this.tracks[n].Instrument]:o[r].Pitch+60,o[r].Duration,o[r].Volume)}})}suspend(){"running"===this.ctx.state&&this.ctx.suspend()}resume(){"suspended"===this.ctx.state&&this.ctx.resume()}close(){"closed"!==this.ctx.state&&this.ctx.close()}toggle(){if(this.dueTime<this.ctx.currentTime)return this.dueTime=void 0,this.play(),void this.resume();switch(this.ctx.state){case"running":this.suspend();break;case"suspended":this.resume()}}}const d=[{token:"undef",foreground:"FF0000"},{token:"comment",foreground:"008800"},{token:"sfunc",foreground:"FF909B"},{token:"func",foreground:"FF909B"},{token:"instr",foreground:"bf00ff",fontStyle:"bold"},{token:"macro",foreground:"7CFC00"},{token:"macroIndicator",foreground:"bf00ff"},{token:"inc",foreground:"7CFC00"},{token:"incPath",foreground:"87CEFA"},{token:"degree",foreground:"00FFFF"},{token:"pitOp-chord",foreground:"00BBFF"},{token:"durOp-stac-volOp",foreground:"00FFBB"},{token:"chordBracket",foreground:"00BBBB"},{token:"@bracket",foreground:"fc8f00"},{token:"volta",foreground:"FFFF00"},{token:"barline",foreground:"fc8f00"},{token:"repeat",foreground:"FFFF00"},{token:"press-release",foreground:"fcde00"},{token:"tie",foreground:"fcde00"}],g={tokenizer:{root:[{regex:/\/\/.*/,action:{token:"comment"}},{regex:/# *Track/,action:{token:"@rematch",next:"Macro"}},{regex:/# *Chord/,action:{token:"@rematch",next:"ChordDef"}},{regex:/# *Include/,action:{token:"@rematch",next:"@Inc"}},{regex:/\[(\d+\.)+\]/,action:{token:"volta"}},{regex:/<[^*]+>/,action:{token:"instr"}},{include:"Common"}],Subtrack:[{regex:/\d+\*|\/\d*:/,action:{token:"repeat"}},{regex:/\//,action:{token:"repeat"}},{regex:/\^\)|\)/,action:{token:"@rematch",next:"@pop"}},{include:"Common"}],Common:[{regex:/@[A-Za-z\d]+/,action:{token:"macroIndicator"}},{regex:/(\$?)([\d%x])/,action:[{token:"func"},{cases:{"@eos":{token:"degree"},"@default":{token:"degree",next:"NoteOp"}}}]},{regex:/(\$?)(\[)/,action:[{token:"func"},{token:"@rematch",next:"Chord"}]},{regex:/\(/,action:{token:"@rematch",next:"Sfunc"}},{regex:/([A-Z][a-z]+)+\(/,action:{token:"@rematch",next:"Func"}},{regex:/{/,action:{bracket:"@open",token:"@bracket",next:"Subtrack"}},{regex:/}/,action:{bracket:"@close",token:"@bracket",next:"@pop"}},{regex:/&/,action:{token:"press-release"}},{regex:/\*/,action:{token:"press-release"}},{regex:/~/,action:{token:"func"}},{regex:/\^/,action:{token:"tie"}},{regex:/:\|\|:|:\|\||\|\|:|\|\||\|/,action:{token:"barline"}}],Sfunc:[{regex:/\(\.\)/,action:{token:"func",next:"@pop"}},{regex:/\(\^/,action:{token:"func",next:"Subtrack"}},{regex:/\(|\^|:|1=/,action:{token:"func"}},{regex:/{/,action:{token:"@bracket",next:"Subtrack"}},{regex:/[^)]+\^\)/,action:{token:"@rematch",next:"Subtrack"}},{regex:/\^\)/,action:{token:"func",next:"@pop"}},{regex:/\)/,action:{token:"func",next:"@pop"}},{regex:/[A-Za-zb#%\d.\-/]/,action:{token:"number"}}],Func:[{regex:/[A-Z][a-z]+/,action:{token:"func"}},{regex:/\(/,action:{token:"func",next:"Arg"}},{regex:/\)/,action:{token:"func",next:"@pop"}},{regex:/,\s*/,action:{token:"func",next:"Arg"}}],Array:[{regex:/\[/,action:{token:"func",bracket:"@open",next:"Arg"}},{regex:/,\s*/,action:{token:"func",next:"Arg"}},{regex:/\]/,action:{token:"func",bracket:"@close",next:"@pop"}}],Arg:[{regex:/{/,action:{token:"@bracket",next:"Subtrack"}},{regex:/"[^"]*"/,action:{token:"string"}},{regex:/\[/,action:{token:"@rematch",next:"Array"}},{regex:/,|\)|\]/,action:{token:"@rematch",next:"@pop"}},{regex:/[^,)}[\]"]+/,action:{token:"number"}}],NoteOp:[{regex:/[^',b#a-wyzA-Z\-_.=`:>]/,action:{token:"@rematch",next:"@pop"}},{include:"NoteAddon"}],NoteAddon:[{regex:/[',b#a-wyzA-Z]/,action:{cases:{"@eos":{token:"pitOp-chord",next:"@pop"},"@default":{token:"pitOp-chord"}}}},{regex:/[-_.=`:>]/,action:{cases:{"@eos":{token:"durOp-stac-volOp",next:"@pop"},"@default":{token:"durOp-stac-volOp"}}}}],Chord:[{regex:/\[/,action:{token:"@rematch",next:"ChordInside"}},{regex:/[^',b#a-wyzA-Z\-_.=`:>]/,action:{token:"@rematch",next:"@pop"}},{include:"NoteAddon"}],ChordInside:[{regex:/\[/,action:{token:"chordBracket"}},{regex:/[\d%]/,action:{token:"degree"}},{regex:/[',b#a-wyzA-Z]/,action:{token:"pitOp-chord"}},{regex:/\]/,action:{token:"chordBracket",next:"@pop"}}],ChordDef:[{regex:/# *Chord/,action:{token:"macro",bracket:"@open"}},{regex:/# *End/,action:{token:"macro",bracket:"@close",next:"@pop"}},{regex:/^.+$/,action:{token:"@rematch",next:"ChordDefLine"}}],ChordDefLine:[{regex:/^[a-wyzA-Z]/,action:{token:"pitOp-chord"}},{regex:/\t+[^\t]+\t+/,action:{token:"comment"}},{regex:/.*/,action:{token:"pitOp-chord",next:"@pop"}}],Macro:[{regex:/# *Track/,action:{token:"macro",bracket:"@open"}},{regex:/<\*[A-Za-z\d]+\*>/,action:{token:"macroIndicator"}},{regex:/# *End/,action:{token:"macro",bracket:"@close",next:"@pop"}},{include:"Common"}],Inc:[{regex:/# *Include/,action:{token:"inc"}},{regex:/".*"/,action:{token:"incPath",next:"@pop"}}],Section:[],Track:[]},tokenPostfix:".sml",defaultToken:"undef"};let m;window.require(["vs/editor/editor.main"],()=>{window.monaco.languages.register({id:"smml",extensions:["sml"]}),window.monaco.editor.defineTheme("smml",{base:"vs-dark",inherit:!0,rules:d,colors:{}}),window.monaco.languages.setMonarchTokensProvider("smml",g),window.monaco.languages.registerDefinitionProvider("smml",{provideDefinition(e,t,n){const o=e.findMatches("@[A-Za-z0-9]+",!1,!0,!1,"",!0).find(e=>e.range.startLineNumber===t.lineNumber&&e.range.endLineNumber===t.lineNumber&&e.range.startColumn<=t.column&&e.range.endColumn>=t.column);if(!o)return;const r=e.findMatches(`<*${o.matches[0].slice(1)}*>`,!1,!1,!0,"",!1)[0];return{uri:e.uri,range:r.range}}}),window.monaco.languages.registerCompletionItemProvider("smml",{triggerCharacters:["<","@"],provideCompletionItems(e,t,n){const o=e.getValueInRange({startLineNumber:t.lineNumber,endLineNumber:t.lineNumber,startColumn:t.column-1,endColumn:t.column});return"<"===o?[{label:"Piano",kind:window.monaco.languages.CompletionItemKind.Variable,documentation:"Piano",insertText:"Piano>"}]:"@"===o?e.findMatches("<\\*([A-Za-z0-9]+)\\*>",!1,!0,!1,"",!0).map(e=>({label:e.matches[1],kind:window.monaco.languages.CompletionItemKind.Variable,insertText:e.matches[1]})):[{label:"Oct",kind:window.monaco.languages.CompletionItemKind.Function,insertText:"foo(${1:bar},frob)"}]}}),function(){const e=document.getElementById("container"),t=window.monaco.editor.createModel(localStorage.getItem("lastText"),"smml"),n=window.monaco.editor.create(e,{model:t,language:"smml",theme:"smml",folding:!1});n.addAction({id:"smml-save",label:"Save File",keybindings:[window.monaco.KeyMod.CtrlCmd|window.monaco.KeyCode.KEY_S],precondition:null,keybindingContext:null,contextMenuGroupId:"navigation",contextMenuOrder:1.5,run(e){const t=e.getValue();localStorage.setItem("lastText",t);const n=t.slice(0,t.indexOf("\n"));let r;r=""!==n&&n.startsWith("//")?n.slice(2).trim():"new_file";const i=new Blob([t],{type:"text/plain;charset=utf-8"});o.saveAs(i,`${r}.sml`)}}),n.addAction({id:"smml-play",label:"Play/Pause",keybindings:[window.monaco.KeyMod.CtrlCmd|window.monaco.KeyCode.KEY_P],precondition:null,keybindingContext:null,contextMenuGroupId:"navigation",contextMenuOrder:1.5,run(e){const t=e.getValue();m instanceof p?m.value===t?m.toggle():(m.close(),(m=new p(t)).play()):(m=new p(t)).play()}}),n.addAction({id:"smml-stop",label:"Stop Playing",keybindings:[window.monaco.KeyMod.CtrlCmd|window.monaco.KeyCode.KEY_T],precondition:null,keybindingContext:null,contextMenuGroupId:"navigation",contextMenuOrder:1.5,run(e){m instanceof p&&(m.close(),m=void 0)}}),addEventListener("resize",e=>{n.layout()}),addEventListener("beforeunload",e=>{const t=n.getValue();""!==t&&localStorage.setItem("lastText",t)}),e.addEventListener("drop",e=>{e.preventDefault();const t=e.dataTransfer;if(t.items&&"file"===t.items[0].kind){const e=t.items[0].getAsFile(),o=new FileReader;o.readAsText(e),o.onload=(()=>n.executeEdits("dnd",[{identifier:"drag & drop",range:new window.monaco.Range(1,1,n.getModel().getLineCount(),n.getModel().getLineMaxColumn(n.getModel().getLineCount())),text:o.result}]))}}),e.addEventListener("dragover",e=>e.preventDefault()),n.updateOptions({mouseWheelZoom:!0});const r=document.getElementById("pre");r.style.opacity=0,r.addEventListener("transitionend",()=>r.remove())}()})},function(e,t){e.exports=class{constructor(){}adapt(e){let t=0;const n={};for(const o of e){const e=[];for(const r of o.Tracks){e.push(r.Meta.Duration);for(const e of r.Content)e.StartTime+=t;r.ID in n?(n[r.ID].Meta.Duration+=r.Meta.Duration,n[r.ID].Content.push(...r.Content)):n[r.ID]=r}t+=Math.max(...e)}return{tracks:Object.values(n),time:t}}}},function(e,t){class n{constructor({Key:e=[0],Volume:t=[1],Bar:n=4,Beat:o=4,Speed:r=60,Stac:i=[0,.5,.75],Accent:a=2,Light:s=.5,Trace:c=1,Duration:u=0,FadeIn:h=0,FadeOut:l=0,Rev:p=0}={}){this.Key=e,this.Bar=n,this.Beat=o,this.Speed=r,this.Volume=t,this.Stac=i,this.Accent=a,this.Light=s,this.Trace=c,this.Duration=u,this.FadeIn=h,this.FadeOut=l,this.Rev=p}getOrSetDefault(e,t){return e in this?this[e]:(t&&(this[e]=t),t)}extend(e={Stac:this.Stac.slice(),Key:this.Key.slice(),Volume:this.Volume.slice()}){const t=new n;return Object.assign(t,this,e),t}update(e){Object.assign(this,e)}assignSetting(e,t,n){if("number"!=typeof t)throw new TypeError(`Non-numeric value passed in as ${e}`);if(!n(t))throw new RangeError(`${e} out of range`);this[e]=t}}e.exports=n},function(e,t,n){const{SubtrackParser:o}=n(0);e.exports={Tremolo1(e,t){const n=new o(t,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),r=60*Math.pow(2,-e)/this.Settings.Speed,i=Math.round(n.Meta.Duration/r),a=[],s=n.Content.length;for(let e=0;e<i;e++){const t=e*r;for(let e=0;e<s;e++)a.push(Object.assign({},n.Content[e],{StartTime:t,Duration:r}))}return{Content:a,Meta:n.Meta}},Tremolo2(e,t,n){const r=[new o(t,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),new o(n,this.Settings,this.Libraries,this.pitchQueue).parseTrack()],i=60*Math.pow(2,-e)/this.Settings.Speed,a=Math.round(r[1].Meta.Duration/i),s=r.map(e=>e.Content.length),c=[];for(let e=0;e<a;e++){const t=e*i,n=e%2;for(let e=0;e<s[n];e++)c.push(Object.assign({},r[n].Content[e],{StartTime:t,Duration:i}))}return{Content:c,Meta:{Duration:r[1].Meta.Duration,Incomplete:r[1].Meta.Incomplete,Single:!0,Warnings:[],PitchQueue:[...r[0].Meta.PitchQueue,...r[1].Meta.PitchQueue],NotesBeforeTie:r[(a-1)%2].Meta.NotesBeforeTie}}},Tuplet(e,t){const n=Math.pow(2,Math.floor(Math.log2(e)))/e,r=new o(t,this.Settings,this.Libraries,this.pitchQueue).parseTrack();return r.Content.forEach(e=>{e.Duration*=n,e.StartTime*=n}),r.Meta.Duration*=n,r.Meta.Incomplete[0]*=n,r},Portamento(e,t){const n=new o(e,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),r=new o(t,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),i=n.Content[0].Pitch,a=r.Content[0].Pitch,s=n.Meta.Duration,c=this.Settings.getOrSetDefault("Port",6),u=s*c*this.Settings.Speed/60,h=(a-i)/(u-1),l=[];for(let e=0;e<u;e++)l.push(Math.round(i+h*e));const p=l.map((e,t)=>({Type:"Note",Pitch:e,Volume:r.Content[0].Volume,Duration:1/c*60/this.Settings.Speed,StartTime:t/c*60/this.Settings.Speed}));return{Content:p,Meta:{Duration:s,Incomplete:[s],Single:!0,Warnings:[],PitchQueue:[...n.Meta.PitchQueue,...r.Meta.PitchQueue],NotesBeforeTie:[p[p.length-1]]}}},GraceNote(e,t){const n=new o(e,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),r=new o(t,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),i=e.Content.length;let a;const s=this.Settings.getOrSetDefault("Seg",.25),c=(a=i<=4?s/4:s/i)*Math.pow(2,-this.Settings.Duration)*60/this.Settings.Speed;n.Content.forEach(e=>{e.Duration=c,e.StartTime*=a});const u=c*i;return r.Content.forEach(e=>{e.StartTime+=u,e.Duration-=u}),{Content:[...n.Content,...r.Content],Meta:r.Meta}},Appoggiatura(e,t){const n=new o(e,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),r=new o(t,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),i=t.Content.length;let a;const s=this.Settings.getOrSetDefault("Seg",.25),c=(a=i<=4?s/4:s/i)*Math.pow(2,-this.Settings.Duration)*60/this.Settings.Speed,u=c*i;return n.Content.forEach(e=>{e.Duration-=u}),r.Content.forEach(e=>{e.Duration=c,e.StartTime*=a,e.StartTime+=n.Content[0].Duration}),n.Meta.NotesBeforeTie=r.Meta.NotesBeforeTie,{Content:[...n.Content,...r.Content],Meta:n.Meta}},Fermata(e){const t=new o(e,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),n=this.Settings.getOrSetDefault("Ferm",2);return t.Content.forEach(e=>{e.Duration*=n,e.StartTime*=n}),t.Meta.Duration*=n,t},Arpeggio(e){const t=new o(e,this.Settings,this.Libraries,this.pitchQueue).parseTrack(),n=t.Content.length-1;let r;const i=this.Settings.getOrSetDefault("Seg",.25),a=(r=n<=4?i/4:i/n)*Math.pow(2,-this.Settings.Duration)*60/this.Settings.Speed,s=[];return t.Content.reduce((e,o,r)=>{if(r<n){const t=Object.assign({},o);e.push(t),t.Duration=a;for(const t of e)s.push(Object.assign({},t,{StartTime:a*r}))}else t.Content.forEach(e=>{e.StartTime+=a*r,e.Duration-=a*r}),s.push(...t.Content);return e},[]),Object.assign(t,{Content:s})},ConOct(e){this.Settings.Key=0===e?[this.Settings.Key[0]]:[this.Settings.Key[0],this.Settings.Key[0]+12*e]},Vol(e){const t=e/100/this.Settings.Volume[0];for(var n=0,o=this.Settings.Volume.length;n<o;n++)this.Settings.Volume[n]*=t},Spd(e){this.Settings.assignSetting("Speed",e,e=>e>0)},Key(e){const t=e-this.Settings.Key[0];for(var n=0,o=this.Settings.Key.length;n<o;n++)this.Settings.Key[n]+=t},Oct(e){const t=12*(e-Math.floor((this.Settings.Key[0]+2)/12));for(var n=0,o=this.Settings.Key.length;n<o;n++)this.Settings.Key[n]+=t},KeyOct(e){const t=e.match(/^((#|b)\2*)?([A-G])(('|,)\5*)?/);let n={C:0,G:7,D:2,A:9,E:4,B:-1,F:5}[t[3]]+(void 0===t[2]?0:"#"===t[2]?t[1].length:-t[1].length)+(void 0===t[5]?0:"'"===t[5]?12*t[4].length:-12*t[4].length)-this.Settings.Key[0];for(var o=0,r=this.Settings.Key.length;o<r;o++)this.Settings.Key[o]+=n},Beat(e){this.Settings.assignSetting("Beat",e,e=>e>0&&Number.isInteger(Math.log2(e)))},Bar(e){this.Settings.assignSetting("Bar",e,e=>e>0&&Number.isInteger(e))},BarBeat(e,t){this.Settings.assignSetting("Bar",e,e=>e>0&&Number.isInteger(e)),this.Settings.assignSetting("Beat",t,e=>e>0&&Number.isInteger(Math.log2(e)))},Dur(e){this.Settings.assignSetting("Duration",e,()=>!0)},Acct(e){this.Settings.assignSetting("Accent",e,e=>e>1)},Light(e){this.Settings.assignSetting("Light",e,e=>e<1&&e>0)},Seg(e){this.Settings.assignSetting("Seg",e,e=>e>0)},Port(e){this.Settings.assignSetting("Port",e,e=>e>0)},Trace(e){this.Settings.assignSetting("Trace",e,e=>e>0&&e<=4&&Number.isInteger(e))},FadeIn(e){this.Settings.assignSetting("FadeIn",e,e=>e>=0)},FadeOut(e){this.Settings.assignSetting("FadeOut",e,e=>e>=0)},Rev(e){this.Settings.assignSetting("Rev",e,()=>!0)},Ferm(e){this.Settings.assignSetting("Ferm",e,e=>e>1)},Stac(e,t=1){if("number"!=typeof e)throw new TypeError("Non-numeric value passed in as Stac");if(!(e=>e>=0&&e<=1)(e))throw new RangeError("Stac out of range");if(![0,1,2].includes(t))throw new RangeError("Stac index out of range");this.Settings.Stac[t]=e}}},function(e,t){class n extends Error{constructor(e,t,...n){super(t),this.name=e,this.args=n}toJSON(){return{ErrID:this.name,Args:this.args}}}e.exports={BarLengthError:class extends n{constructor(e,t,n){super("BarLength","",e,t,n)}},DupChordError:class extends n{constructor(e,t,n){super("DupChord","",e,t,n)}},TraceError:class extends n{constructor(e,t,n){super("Trace","",e,t,n)}},VolumeError:class extends n{constructor(e,t,n){super("Trace","",e,t,n)}}}},function(module,exports,__webpack_require__){const{SubtrackParser:SubtrackParser}=__webpack_require__(0);class LibLoader{constructor(e=[],t=!0){this.libs=e,this.result={Chord:{},MetaInformation:{},FunctionPackage:{Custom:{}},MIDIEventList:{},Track:{}},t&&Object.assign(this.result,LibLoader.Default)}load(){for(const e of this.libs)this.loadLibrary(e);return this.result}loadLibrary(e){switch(e.Type){case LibLoader.libType.Chord:e.Data.forEach(e=>{this.result.Chord[e.Notation]=e.Pitches});break;case LibLoader.libType.Track:for(const t of e.Data)this.result.Track[t.Name]=t.Content;break;case LibLoader.libType.MetaInformation:break;case LibLoader.libType.FunctionPackage:this.loadCode(e.Data);break;case LibLoader.libType.MIDIEventList:break;case LibLoader.libType.Library:this.loadSubPackage(e.Content)}}loadCode(data){const code="this.result.FunctionPackage.Custom = {"+data.map(e=>e.Code).join(",")+"}";eval(code)}loadSubPackage(e){const t=new LibLoader(e,!1).load();Object.assign(this.result.Chord,t.Chord),Object.assign(this.result.FunctionPackage.Custom,t.FunctionPackage.Custom),Object.assign(this.result.MetaInformation,t.MetaInformation),Object.assign(this.result.MIDIEventList,t.MIDIEventList),Object.assign(this.result.Track,t.Track)}}LibLoader.libType={Chord:"Chord",MetaInformation:"MetaInformation",FunctionPackage:"Function",MIDIEventList:"MIDIEventList",Library:"Package",Track:"Track"},LibLoader.Default={Chord:{M:[[1,1,0],[1,1,4],[1,1,7]],m:[[1,1,0],[1,1,3],[1,1,7]],a:[[1,1,0],[1,1,4],[1,1,8]],d:[[1,1,0],[1,1,3],[1,1,6]],t:[[1,-1,0],[1,1,3]],T:[[1,-1,0],[1,1,4]],q:[[1,-1,0],[1,1,5]],Q:[[1,-1,0],[1,1,6]],p:[[1,-1,0],[1,1,7]],P:[[1,-1,0],[1,1,8]],h:[[1,-1,0],[1,1,9]],H:[[1,-1,0],[1,1,10]],s:[[1,-1,0],[1,1,11]],o:[[1,-1,0],[1,1,12]],u:[[-1,-1,-12],[1,-1,0]],i:[[1,1,12],[2,-1,0]],j:[[1,2,12],[3,-1,0]],k:[[1,3,12],[4,-1,0]]},MetaInformation:{},FunctionPackage:{STD:__webpack_require__(5),Custom:{},applyFunction(parser,token){return this.locateFunction(token.Name).apply({Settings:parser.Settings,Libraries:parser.Libraries,pitchQueue:parser.Context.pitchQueue},token.Argument.map(arg=>{switch(arg.Type){case"Number":case"String":return arg.Content;case"Expression":return eval(arg.Content.replace(/Log2/g,"Math.log2"));default:return arg}}))},locateFunction(e){return e in this.STD?this.STD[e]:e in this.Custom?this.Custom[e]:()=>{}}},MIDIEventList:{},Track:{}},module.exports=LibLoader},function(e,t,n){const o=n(7),r=n(4),{TrackParser:i}=n(0);e.exports=class{constructor(e,t){this.tokenizedData=e,this.libraries=new o(this.tokenizedData.Library).load(),this.result={Sections:void 0},this.sectionContext={Settings:new r},this.order=[],this.adapter=t}parse(){const e=[];return this.generateOrder(),this.order.forEach(t=>{e.push(this.parseSection(this.tokenizedData.Sections[t]))}),this.result=e,void 0===this.adapter?e:this.adapter.adapt(e)}generateOrder(){const e=this.tokenizedData.Sections.map(e=>{const t=e.Settings.find(e=>"Volta"===e.Type);let n;return n=t?t.Order:void 0,{RepeatBegin:!!e.Settings.find(e=>"RepeatBegin"===e.Type),RepeatEnd:!!e.Settings.find(e=>"RepeatEnd"===e.Type),Volta:n}}),t=e.length;let n=0,o=0,r=1,i=!0;for(;n<t;){if(e[n].RepeatEnd){if(i&&(e[n].RepeatEnd=!1),1===r){n=o,r+=1;continue}{let i=o,a=!1;for(;i<t&&!e[i].RepeatBegin;){if(e[i].Volta&&-1!==e[i].Volta.indexOf(r+1)){a=!0;break}i+=1}if(a){n=o,r+=1;continue}this.order.push(n),n+=1}}e[n].RepeatBegin?(o=n,e[n].RepeatBegin=!1,r=1):e[n].Volta?-1===e[n].Volta.indexOf(r)?n+=1:(e[n].Volta.splice(e[n].Volta.indexOf(r),1),i=0===e[n].Volta.length,this.order.push(n),n+=1):(this.order.push(n),n+=1)}}parseSection(e){e.Settings.filter(e=>"FUNCTION"===e.Type).forEach(e=>this.libraries.FunctionPackage.applyFunction({Settings:this.sectionContext.Settings,Context:{}},e));const t={};return{ID:e.ID,Tracks:[].concat(...e.Tracks.map(e=>{const n=new i(e,this.sectionContext.Settings,this.libraries).parseTrack();for(const o of n)o.Instrument in t?t[o.Instrument]+=1:t[o.Instrument]=1,""===e.ID&&(o.ID+="#"+t[o.Instrument].toString());return n}))}}}},function(e,t){e.exports=class{constructor(e){this.player=e,this.cached=[]}async load(e,t,n){if(!(n in window.fonts)&&-1===this.cached.indexOf(n)){this.cached.push(n);const o=await fetch(t,{mode:"cors"}),r=await o.json();await this.player.adjustPreset(e,r),window.fonts[n]=r}return n}}},function(e,t,n){const o=n(9);e.exports=class{constructor(){this.envelopes=[],this.loader=new o(this),this.onCacheFinish=null,this.onCacheProgress=null,this.afterTime=.05,this.nearZero=1e-6}queueChord(e,t,n,o,r,i,a,s){for(var c=0;c<r.length;c++)this.queueWaveTable(e,t,n,o,r[c],i,a-.01*Math.random(),s)}queueStrumUp(e,t,n,o,r,i,a,s){r.sort((e,t)=>t-e),this.queueStrum(e,t,n,o,r,i,a,s)}queueStrumDown(e,t,n,o,r,i,a,s){r.sort((e,t)=>e-t),this.queueStrum(e,t,n,o,r,i,a,s)}queueStrum(e,t,n,o,r,i,a,s){a?a*=1:a=1,o<e.currentTime&&(o=e.currentTime);for(var c=0;c<r.length;c++)this.queueWaveTable(e,t,n,o+.01*c,r[c],i,a-.01*Math.random(),s),a*=.9}queueSnap(e,t,n,o,r,i,a,s){a=1.5*(1|a),this.queueChord(e,t,n,o,r,.05,a,s)}queueWaveTable(e,t,n,o,r,i,a,s){a?a*=1:a=1;var c=this.findZone(e,n,r);if(c.buffer){var u=c.originalPitch-100*c.coarseTune-c.fineTune,h=1*Math.pow(2,(100*r-u)/1200),l=o;l<e.currentTime&&(l=e.currentTime);var p=i+this.afterTime,d=!0;(c.loopStart<1||c.loopStart>=c.loopEnd)&&(d=!1),d||p>c.buffer.duration/h&&(p=c.buffer.duration/h);var g=this.findEnvelope(e,t,l,p);if(this.setupEnvelope(e,g,c,a,l,p,i),g.audioBufferSourceNode=e.createBufferSource(),g.audioBufferSourceNode.playbackRate.value=h,s&&s.length>0){g.audioBufferSourceNode.playbackRate.setValueAtTime(h,o);for(var m=0;m<s.length;m++){var f=1*Math.pow(2,(100*s[m].pitch-u)/1200),S=o+s[m].when;g.audioBufferSourceNode.playbackRate.linearRampToValueAtTime(f,S)}}return g.audioBufferSourceNode.buffer=c.buffer,d?(g.audioBufferSourceNode.loop=!0,g.audioBufferSourceNode.loopStart=c.loopStart/c.sampleRate+c.delay,g.audioBufferSourceNode.loopEnd=c.loopEnd/c.sampleRate+c.delay):g.audioBufferSourceNode.loop=!1,g.audioBufferSourceNode.connect(g),g.audioBufferSourceNode.start(l,c.delay),g.audioBufferSourceNode.stop(l+p),g.when=l,g.duration=p,g.pitch=r,g.preset=n,g}console.log("empty buffer ",c)}setupEnvelope(e,t,n,o,r,i,a){t.gain.setValueAtTime(this.noZeroVolume(0),e.currentTime);var s=0,c=0,u=a,h=n.ahdsr;i<u+this.afterTime&&(u=i-this.afterTime),h?h.length>0||(h=[{duration:0,volume:1},{duration:.5,volume:1},{duration:1.5,volume:.5},{duration:3,volume:0}]):h=[{duration:0,volume:1},{duration:u,volume:1}],t.gain.cancelScheduledValues(r),t.gain.setValueAtTime(this.noZeroVolume(h[0].volume*o),r);for(var l=0;l<h.length;l++)if(h[l].duration>0){if(h[l].duration+s>u){var p=c-(1-(h[l].duration+s-u)/h[l].duration)*(c-h[l].volume);t.gain.linearRampToValueAtTime(this.noZeroVolume(o*p),r+u);break}s+=h[l].duration,c=h[l].volume,t.gain.linearRampToValueAtTime(this.noZeroVolume(o*c),r+s)}t.gain.linearRampToValueAtTime(this.noZeroVolume(0),r+u+this.afterTime)}findEnvelope(e,t){var n=void 0;for(const o of this.envelopes)if(o.target===t&&e.currentTime>o.when+o.duration+.1){try{o.audioBufferSourceNode.disconnect(),o.audioBufferSourceNode.stop(0),o.audioBufferSourceNode=null}catch(e){}n=o;break}return void 0===n&&((n=e.createGain()).target=t,n.connect(t),n.cancel=(()=>{n.when+n.duration>e.currentTime&&(n.gain.cancelScheduledValues(0),n.gain.setTargetAtTime(1e-5,e.currentTime,.1),n.when=e.currentTime+1e-5,n.duration=0)}),this.envelopes.push(n)),n}adjustZone(e,t){if(!t.buffer)if(t.delay=0,t.loopStart=this.numValue(t.loopStart,0),t.loopEnd=this.numValue(t.loopEnd,0),t.coarseTune=this.numValue(t.coarseTune,0),t.fineTune=this.numValue(t.fineTune,0),t.originalPitch=this.numValue(t.originalPitch,6e3),t.sampleRate=this.numValue(t.sampleRate,44100),t.sustain=this.numValue(t.originalPitch,0),t.sample){const s=atob(t.sample);t.buffer=e.createBuffer(1,s.length/2,t.sampleRate);for(var n,o,r,i=t.buffer.getChannelData(0),a=0;a<s.length/2;a++)n=s.charCodeAt(2*a),o=s.charCodeAt(2*a+1),n<0&&(n=256+n),o<0&&(o=256+o),(r=256*o+n)>=32768&&(r-=65536),i[a]=r/65536}else if(t.file){var s=t.file.length,c=new ArrayBuffer(s),u=new Uint8Array(c);const n=atob(t.file);var h;for(a=0;a<n.length;a++)h=n.charCodeAt(a),u[a]=h;return new Promise((t,n)=>{e.decodeAudioData(c,t,n)}).then(e=>{t.buffer=e})}}cancelQueue(e){for(const t of this.envelopes){t.gain.cancelScheduledValues(0),t.gain.setValueAtTime(this.nearZero,e.currentTime),t.when=-1;try{t.audioBufferSourceNode.disconnect()}catch(e){console.log(e)}}}adjustPreset(e,t){return Promise.all(t.zones.map(t=>this.adjustZone(e,t)))}findZone(e,t,n){return t.zones.find(e=>e.keyRangeLow<=n&&e.keyRangeHigh+1>=n)}noZeroVolume(e){return e>this.nearZero?e:this.nearZero}numValue(e,t){return"number"==typeof e?e:t}}},function(e,t){const n=[{pat:[{Type:"Sfunc",Content:[/^(\d+)-/]},{Type:"Subtrack"}],transform:e=>({Type:"FUNCTION",Name:"Tremolo1",Simplified:!0,Argument:[{Type:"Expression",Content:e[0].Content[0].Content.slice(0,-1)},e[1]]})},{pat:[{Type:"Subtrack"},{Type:"Sfunc",Content:[/^(\d+)=/]},{Type:"Subtrack"}],transform:e=>({Type:"FUNCTION",Name:"Tremolo2",Simplified:!0,Argument:[e[0],{Type:"Expression",Content:e[1].Content[0].Content.slice(0,-1)},e[2]]})},{pat:[{Type:"Subtrack"},{Type:"Undef",Content:"~"},{Type:"Subtrack"}],transform:e=>({Type:"FUNCTION",Name:"Porttamento",Simplified:!0,Argument:[e[0],e[2]]})},{pat:[{Type:"Undef",Content:"$"},{Type:"Note"}],transform:e=>({Type:"FUNCTION",Name:"Arpeggio",Simplified:!0,Argument:[{Type:"Subtrack",Repeat:-1,Content:[e[1]]}]})},{pat:[{Type:"Sfunc",Content:[/^\./]},{Type:"Subtrack"}],transform:e=>({Type:"FUNCTION",Name:"Fermata",Simplified:!0,Argument:[e[1]]})},{pat:[{Type:"Sfunc",Content:[/(\d+)~/]},{Type:"Subtrack"}],transform:e=>({Type:"FUNCTION",Name:"Tuplet",Simplified:!0,Argument:[{Type:"Expression",Content:e[0].Content[0].Content.slice(0,-1)},e[1]]})},{pat:[{Type:"Sfunc",Content:[{Type:"Subtrack"},/^\^/]},{Type:"Note"}],transform:e=>({Type:"FUNCTION",Name:"GraceNote",Simplified:!0,Argument:[e[0].Content[0],{Type:"Subtrack",Content:[e[1]],Repeat:-1}]})},{pat:[{Type:"Note"},{Type:"Sfunc",Content:[/^\^/,{Type:"Subtrack"}]}],transform:e=>({Type:"FUNCTION",Name:"Appoggiatura",Simplified:!0,Argument:[{Type:"Subtrack",Content:[e[0]],Repeat:-1},e[1].Content[1]]})}],o={Dynamic:[{regex:/^{(\d+\*)?/,action:{token:"subtrack",next:"root",transform(e,t){let n;if(void 0!==e[1])n=e[1].slice(0,-1);else{const e=t.filter(e=>"BarLine"===e.Type&&e.Order[0]>0);n=e.length>0?Math.max(...e.map(e=>Math.max(...e.Order))):-1}return{Type:"Subtrack",Repeat:n,Content:t}}}},{regex:/^\)/,action:{token:"@pass",next:"@pop"}},{regex:/^[^{)]+/,action:{token:"dyn",transform:e=>({Type:"Dyn",Content:e[0]})}}],root:[{regex:/^([0-7x%])([',#b]*)([A-Zac-wyz]*)([',#b]*)([-_.=]*)(`*)([:>]*)/,action:{token:"note",transform:e=>({Type:"Note",Pitches:[{Degree:e[1],PitOp:void 0===e[2]?"":e[2],Chord:void 0===e[3]?"":e[3]}],PitOp:void 0===e[4]?"":e[4],DurOp:void 0===e[5]?"":e[5],VolOp:void 0===e[7]?"":e[7],Staccato:void 0===e[6]?0:e[6].length})}},{regex:/^\[(([0-7x%][',#A-Za-wyz:>]*)+)\]([',#b]*)([-_.=]*)(`*)([:>]*)/,action:{token:"chord",transform:e=>({Type:"Note",Pitches:e[1].match(/[0-7x%][',#A-Za-wyz]*/g).map(e=>{const t=e.match(/([0-7x%])([',#b]*)([ac-zA-Z]*)([:>]*)/);return{Degree:t[1],PitOp:void 0===t[2]?"":t[2],Chord:void 0===t[3]?"":t[3],VolOp:void 0===t[4]?"":t[4]}}),PitOp:void 0===e[3]?"":e[3],DurOp:void 0===e[4]?"":e[4],VolOp:void 0===e[6]?"":e[6],Staccato:void 0===e[5]?0:e[5].length})}},{regex:/^(:\|\|:|:\|\||\|\|:|\||\/([\d,~\s])*:|\/)/,action:{cases:{":||:":{token:"rEB"},":||":{token:"rE",transform:()=>({Type:"RepeatEnd"})},"||:":{token:"rB",transform:()=>({Type:"RepeatBegin"})},"|":{token:"ba",transform:()=>({Type:"BarLine",Skip:!1,Order:[0]})},"/":{token:"skip",transform:()=>({Type:"BarLine",Skip:!0,Order:[0]})},"@default":{token:"pos",transform(e){let t=[];if(void 0!==e[1]){const o=e[1].split(",");for(const e of o)if(e.includes("~")){const[o,r]=e.split("~");for(var n=o;n<=r;n++)t.push(n)}else t.push(Number(e))}return{Type:"BarLine",Skip:!1,Order:t}}}}}},{regex:/^\((\w+):([\d-]+)\)/,action:{token:"sfunc",transform:e=>({Type:"FUNCTION",Name:e[1],Argument:[{Type:"Number",Content:Number(e[2])}]})}},{regex:/^\((\d+)\/(\d+)\)/,action:{token:"sfunc",transform:e=>({Type:"FUNCTION",Name:"BarBeat",Argument:[{Type:"Number",Content:Number(e[1])},{Type:"Number",Content:Number(e[2])}]})}},{regex:/^\(1=([A-G',b#]+)\)/,action:{token:"sfunc",transform:e=>({Type:"FUNCTION",Name:"KeyOct",Argument:[{Type:"String",Content:e[1]}]})}},{regex:/^\((\d+)%\)/,action:{token:"sfunc",transform:e=>({Type:"FUNCTION",Name:"Vol",Argument:[{Type:"Number",Content:Number(e[1])}]})}},{regex:/^\((\d+)\)/,action:{token:"sfunc",transform:e=>({Type:"FUNCTION",Name:"Spd",Argument:[{Type:"Number",Content:Number(e[1])}]})}},{regex:/^\(/,action:{token:"sfunc",next:"Dynamic",transform:(e,t)=>({Type:"Sfunc",Content:t})}},{regex:/^\[(\d+\.)+\]/,action:{token:"volta",transform:e=>({Type:"Volta",Order:e[0].slice(1,-1).split(".").slice(0,-1).map(e=>Number(e))})}},{regex:/^<([A-Za-z0-9]+:)?([A-Za-z0-9]+(\(.+\))?)(,[A-Za-z0-9]+(\(.+\))?)*>/,action:{token:"instr",transform(e){const t=e[2].split(",").map(e=>{const t=e.match(/(\w+)(\(\d+%\))?/);return{Instrument:t[1],Proportion:void 0===t[2]?null:Number(t[2].slice(1,-2))/100}});return t.unshift(void 0===e[1]?void 0:e[1].slice(0,-1)),t}}},{regex:/^@[a-z]+/,action:{token:"macroIndicator",transform:e=>({Type:"Macrotrack",Name:e[0].slice(1)})}},{regex:/^([A-Za-z]\w*)\s*\(/,action:{token:"func",next:"Func",transform:(e,t)=>({Type:"FUNCTION",Name:e[1],Argument:t})}},{regex:/^{(\d+\*)?/,action:{token:"subtrack",next:"root",transform(e,t){let n;if(void 0!==e[1])n=e[1].slice(0,-1);else{const e=t.filter(e=>"BarLine"===e.Type&&e.Order[0]>0);n=e.length>0?Math.max(...e.map(e=>Math.max(...e.Order))):-1}return{Type:"Subtrack",Repeat:n,Content:t}}}},{regex:/^}/,action:{token:"@pass",next:"@pop"}},{regex:/^&/,action:{token:"pr",transform:()=>({Type:"PedalPress"})}},{regex:/^\*/,action:{token:"pr",transform:()=>({Type:"PedalRelease"})}},{regex:/^\^/,action:{token:"tie",transform:()=>({Type:"Tie"})}},{regex:/./,action:{token:"undef",transform:e=>({Type:"Undef",Content:e[0]})}}],Func:[{regex:/^\)/,action:{token:"@pass",next:"@pop"}},{regex:/^,\s*/,action:{token:"@pass"}},{regex:/^{(\d+\*)?/,action:{token:"subtrack",next:"root",transform(e,t){let n;if(void 0!==e[1])n=e[1].slice(0,-1);else{const e=t.filter(e=>"BarLine"===e.Type&&e.Order[0]>0);n=e.length>0?Math.max(...e.map(e=>Math.max(...e.Order))):-1}return{Type:"Subtrack",Repeat:n,Content:t}}}},{regex:/^"([^"]*)"/,action:{token:"string",transform:e=>({Type:"String",Content:e[1]})}},{regex:/^\[/,action:{token:"array",next:"Array",transform:(e,t)=>({Type:"Array",Content:t})}},{regex:/^[^,)}[\]"]+/,action:{token:"number",transform:e=>({Type:"Expression",Content:e[0]})}}],Array:[{regex:/^,\s*/,action:{token:"@pass"}},{regex:/^\]/,action:{token:"@pass",next:"@pop"}},{regex:/^{(\d+\*)?/,action:{token:"subtrack",next:"root",transform(e,t){let n;if(void 0!==e[1])n=e[1].slice(0,-1);else{const e=t.filter(e=>"BarLine"===e.Type&&e.Order[0]>0);n=e.length>0?Math.max(...e.map(e=>Math.max(...e.Order))):-1}return{Type:"Subtrack",Repeat:n,Content:t}}}},{regex:/^"([^"]*)"/,action:{token:"string",transform:e=>({Type:"String",Content:e[1]})}},{regex:/^\[/,action:{token:"array",next:"Array",transform:(e,t)=>({Type:"Array",Content:t})}},{regex:/^[^,)}[\]"]+/,action:{token:"number",transform:e=>({Type:"Expression",Content:e[0]})}}]},r=[{regex:/^#\s*Chord([^]+?)\r?\n(?=#)/,type:"Chord",transform(e){const t=[],n=e[1].split(/\r?\n/);for(const e of n){const n=e.match(/^([A-Za-z])\t+([^\t]+)\t+([^\t]+)/);if(null===n)continue;const o=n[3].split(","),r=[];for(const e of o){const t=Number(e);if(Number.isNaN(t)){const t=e.trim().match(/\[(.*?)\](-?\d+)?/);let n;if(n=void 0===t[2]?0:Number(t[2]),""===t[1])r.push([1,-1,n]);else{const e=Number(t[1]);if(Number.isNaN(e)){let[e,o]=t[1].split(";");e=Number(e),o=""===o?-1:Number(o),r.push([e,o,n])}else r.push([e,e,n])}}else r.push([1,1,t])}t.push({Notation:n[1],Comment:n[2],Pitches:r})}return{Type:"Chord",Data:t}}},{regex:/^#\s*Function([^]+?)\r?\n(?=#)/,type:"Function",transform:e=>({Type:"Function",Data:[]})},{regex:/^#\s*Track([^]+?)\r?\n(?=#)/,type:"Macro",transform(e){const t=[],n=e[0].match(/<\*\w+\*>[^]+?(?=<\*(\w+)\*>|$)/g);for(const e of n){const[n,o,r]=e.match(/<\*(\w+)\*>([^]+)/);t.push({Name:o,Content:i.tokenizeTrack(r)})}return{Type:"Track",Data:t}}},{regex:/^#\s*End/,type:"@terminal"}];class i{static tokenizeTrack(e){e=e.trim();const t=[[]],r=["root"];let i=0,a=0;for(;a<e.length;){const s=e.slice(a),c=s.trim();let u=!1;a+=s.length-c.length;const h=o[r[i]];for(let e=0;e<h.length;e++){const o=h[e],s=c.match(o.regex);if(null===s)continue;let l;if(u=!0,"next"in(l="cases"in o.action?s[0]in o.action.cases?o.action.cases[s[0]]:o.action.cases["@default"]:o.action))if("@pass"!==l.token&&t[i].push(e=>l.transform(s,e)),"@pop"===l.next){i-=1;const e=t.pop();for(let t=0;t<n.length;t++){const o=n[t];for(let t=0;t<=e.length-o.pat.length;t++){let n=!0;for(let r=0;r<o.pat.length;r++){if(o.pat[r].Type!==e[t+r].Type){n=!1;break}if("sfunc"===o.pat[r].Type)for(let i=0;i<o.pat[r].Content.length;i++)if(o.pat[r].Content[i]instanceof RegExp&&!o.pat[r].Content[i].test(e[t+r].Content[i])){n=!1;break}}n&&e.splice(t,o.pat.length,o.transform(e.slice(t,t+o.pat.length)))}}r.pop(),t[i].push(t[i].pop()(e))}else t.push([]),r.push(l.next),i+=1;else"@pass"!==l.token&&t[i].push(l.transform(s));a+=s[0].length;break}}const s=t[0];for(let e=0;e<n.length;e++){const t=n[e];for(let e=1;e<=s.length-t.pat.length;e++){let n=!0;for(let o=0;o<t.pat.length;o++){if(t.pat[o].Type!==s[e+o].Type){n=!1;break}if("Sfunc"===t.pat[o].Type){for(let r=0;r<t.pat[o].Content.length;r++)if(t.pat[o].Content[r]instanceof RegExp){if("Dyn"!==s[e+o].Content[r].Type||!t.pat[o].Content[r].test(s[e+o].Content[r].Content)){n=!1;break}}else if(t.pat[o].Content[r].Type!==s[e+o].Content[r].Type){n=!1;break}}else if("Undef"===t.pat[o].Type&&t.pat[o].Content!==s[e+o].Content){n=!1;break}}n&&s.splice(e,t.pat.length,t.transform(s.slice(e,e+t.pat.length)))}}return s}static isHeadTrack(e){const t=["Volta","RepeatBegin","RepeatEnd"],n=["ConOct","Vol","Spd","Key","Oct","KeyOct","Beat","Bar","BarBeat","Dur","Acct","Light","Seg","Port","Trace","FadeIn","FadeOut","Rev","Ferm","Stac"];return e.every(e=>t.includes(e.Type)||"FUNCTION"===e.Type&&n.includes(e.Name))}constructor(e){this.content=e,this.include=[],this.sections=[],this.libs=void 0,this.result={Library:[],Sections:[]}}tokenize(){this.regularize(),this.removeComment(),this.extractHeader(),this.split();for(const e of this.sections){const t={Settings:[],Tracks:[]};for(const n of e){const e=i.tokenizeTrack(n);if(e[0]instanceof Array){const n=e.shift(),o=n.shift();t.Tracks.push({ID:o,Instruments:n,Content:e})}else i.isHeadTrack(e)?t.Settings.push(...e):t.Tracks.push({ID:null,Instruments:[{Instrument:"",Proportion:null}],Content:e})}this.result.Sections.push(t)}return this.result}split(){const e=this.content.split(/(\r?\n){3,}/);for(let t=0,n=e.length;t<n;t++){const n=e[t],o=[];if(""!==n&&"\n"!==n&&"\r\n"!==n){const e=n.split(/\r?\n\r?\n/);for(let t=0,n=e.length;t<n;t++){const n=e[t];""!==n&&o.push(n.replace(/\r?\n/,""))}this.sections.push(o)}}}regularize(){}removeComment(){this.content=this.content.replace(/\/\/.*$/gm,"")}extractHeader(){this.content=this.content.replace(/^#\s*Include\s+"([^"]+)"/gm,(e,t)=>(this.result.Library.push({Type:"Package",Path:t,Content:new a(t,!1).tokenize()}),""));const e=this.content.match(/^#\s*End/m);if(null!==e){const t=this.content.split(e[0]);this.result.Library.push(...new a(t[0]+e[0]).tokenize()),this.content=t[1]}}}class a{constructor(e,t=!0){this.inc=[],this.content=void 0,t?this.content=e.trim():this.load(e)}load(e){this.content="".replace(/^#\s*Include\s+"([^"]+)"/gm,(e,t)=>(this.inc.push(t),""))}tokenize(){const e=[];let t=0;for(const t of this.inc)e.push({Type:"Package",Path:name,Content:new a(t,!1).tokenize()});for(;t<this.content.length;){const n=this.content.slice(t),o=n.trim();t+=n.length-o.length;for(let n=0;n<r.length;n++){const i=r[n],a=o.match(i.regex);if(null!==a){if("@terminal"===i.type)return e;e.push(i.transform(a)),t+=a[0].length;break}}}return e}}e.exports=i},function(e,t){(function(t){e.exports=t}).call(this,{})},function(e,t){e.exports=function(){throw new Error("define cannot be used indirect")}}]);